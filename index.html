<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKì¼ë ‰ë§í¬ ì±„ìš© ì „ëµ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --sk-red: #E6221A; --sk-orange: #F37021; --sk-gray: #53565A; --sk-light-gray: #f0f2f5; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--sk-light-gray); margin: 0; padding: 20px; }
        .header { background: linear-gradient(90deg, var(--sk-red), var(--sk-orange)); color: white; padding: 1rem; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .metric-card { background: white; padding: 15px; border-radius: 12px; text-align: center; border-bottom: 5px solid var(--sk-red); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .metric-value { font-size: 1.6rem; font-weight: bold; color: var(--sk-red); margin: 5px 0; }
        .metric-sub { font-size: 0.7rem; color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: block; }
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .full-width { grid-column: 1 / -1; }
        .chart-container { position: relative; min-height: 350px; width: 100%; }
        h2 { font-size: 1rem; margin-top: 0; color: #333; border-left: 4px solid var(--sk-red); padding-left: 10px; margin-bottom: 20px; }
        /* ìµœí•˜ë‹¨ ì§„í–‰ì¤‘ í¬ì§€ì…˜ ë¦¬ìŠ¤íŠ¸ */
        .pos-list-full { list-style: none; padding: 0; margin: 0; }
        .pos-item-full { background: #fff; padding: 12px 20px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 8px; display: flex; align-items: center; font-size: 0.95rem; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .pos-item-full::before { content: 'ğŸš€'; margin-right: 12px; }
    </style>
</head>
<body>

<div class="header"><h1>SK electlink Recruitment Dashboard</h1></div>

<div class="metric-grid">
    <div class="metric-card"><h3>ì§„í–‰ì¤‘ ê³µê³ </h3><div id="openCount" class="metric-value">-</div></div>
    <div class="metric-card"><h3>ì „ëµì±„ìš©</h3><div id="strategyCount" class="metric-value">-</div></div>
    <div class="metric-card"><h3>í‰ê·  ë¦¬ë“œíƒ€ì„</h3><div id="avgLeadTime" class="metric-value">-</div></div>
    <div class="metric-card"><h3>ìµœë‹¨ ë¦¬ë“œíƒ€ì„</h3><div id="minLeadTime" class="metric-value">-</div><div id="minLeadPos" class="metric-sub">-</div></div>
    <div class="metric-card"><h3>ìµœì¥ ë¦¬ë“œíƒ€ì„</h3><div id="maxLeadTime" class="metric-value">-</div><div id="maxLeadPos" class="metric-sub">-</div></div>
    <div class="metric-card"><h3>2026 ì”ì—¬ T.O</h3><div id="totalTO" class="metric-value">-</div></div>
</div>

<div class="chart-grid">
    <div class="card full-width"><h2>ì›”ë³„ ì±„ìš© ì™„ë£Œ ì¶”ì´</h2><div class="chart-container"><canvas id="monthlyChart"></canvas></div></div>
    <div class="card full-width"><h2>ì¡°ì§ ë° íŒ€ë³„ ì”ì—¬ T.O í˜„í™©</h2><div class="chart-container"><canvas id="toRemainChart"></canvas></div></div>
    <div class="card full-width"><h2>ì…€ë³„ ì±„ìš© ì™„ë£Œ í˜„í™©</h2><div id="doneContainer" class="chart-container"><canvas id="toDoneChart"></canvas></div></div>
    <div class="card"><h2>ì±„ìš© ì™„ë£Œ ì§êµ° êµ¬ì„±</h2><div class="chart-container"><canvas id="categoryChart"></canvas></div></div>
    <div class="card"><h2>ê³ ìš© í˜•íƒœë³„</h2><div class="chart-container"><canvas id="typeChart"></canvas></div></div>
    <div class="card full-width"><h2>ì±„ìš© ì‚¬ìœ ë³„</h2><div class="chart-container"><canvas id="reasonChart"></canvas></div></div>
</div>

<div class="card full-width">
    <h2>í˜„ì¬ ì§„í–‰ ì¤‘ì¸ í¬ì§€ì…˜ ëª…ë‹¨</h2>
    <div id="positionListFull" class="pos-list-full">ë°ì´í„° ë¡œë”© ì¤‘...</div>
</div>

<script>
    const posUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS4NyWr_pNBx82IrYqAeZV60ST3D14ZzH2F1uYsHrpGWQ9PQ8KP8MLR98Ao_yppXjwqoHwqR-AvLRyR/pub?gid=867729802&single=true&output=csv";
    const toUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS4NyWr_pNBx82IrYqAeZV60ST3D14ZzH2F1uYsHrpGWQ9PQ8KP8MLR98Ao_yppXjwqoHwqR-AvLRyR/pub?gid=770067438&single=true&output=csv";

    let charts = {};
    const intAxis = { ticks: { stepSize: 1, precision: 0 }, beginAtZero: true };

    function init() {
        Papa.parse(posUrl, { download: true, header: true, skipEmptyLines: true, complete: res => processPos(res.data) });
        Papa.parse(toUrl, { download: true, header: false, skipEmptyLines: true, complete: res => processTO(res.data) });
    }

    function processPos(data) {
        const active = data.filter(d => String(d['ìƒíƒœ']).trim() === 'ì§„í–‰ì¤‘');
        const done = data.filter(d => String(d['ìƒíƒœ']).trim() === 'ì™„ë£Œ');

        // 1. ì „ëµì±„ìš© (í‘œ ê¸°ë°˜ ì¹´ìš´íŠ¸: ê³µê³ ëª…ì— ì „ëµì´ í¬í•¨ëœ ëª¨ë“  í–‰)
        const stratData = data.filter(d => String(d['ê³µê³ ëª…']).includes('ì „ëµ'));
        document.getElementById('strategyCount').innerText = stratData.length + "ê±´";
        document.getElementById('openCount').innerText = active.length + "ê±´";

        // 2. ìµœí•˜ë‹¨ ë¦¬ìŠ¤íŠ¸ (í•œ ì¤„ì— í•˜ë‚˜ì”©)
        document.getElementById('positionListFull').innerHTML = active.map(d => `<div class="pos-item-full">${d['ê³µê³ ëª…']}</div>`).join('');

        // 3. ì›”ë³„ ì¶”ì´ (1ì›” 5ëª… ë³´ì •)
        const months = { "2025-12": 0, "2026-01": 0, "2026-02": 0 };
        done.forEach(d => {
            const m = String(d['ìµœì¢… í•©ê²©ì¼']).match(/(\d{4})[\.\s-]+(\d{1,2})/);
            if(m) {
                const key = `${m[1]}-${m[2].padStart(2, '0')}`;
                if(months.hasOwnProperty(key)) months[key]++;
            }
        });
        updateChart('monthlyChart', 'bar', ["25ë…„ 12ì›”", "26ë…„ 1ì›”", "26ë…„ 2ì›”"], [{ label: 'ì¸ì›', data: Object.values(months), backgroundColor: '#E6221A' }], { scales: { y: intAxis } });

        // 4. ë¦¬ë“œíƒ€ì„ ìƒì„¸ ë³µêµ¬
        let lt = [];
        done.forEach(d => {
            const s = new Date(String(d['ì˜¤í”ˆ ë‚ ì§œ']).replace(/\./g, '-'));
            const e = new Date(String(d['ìµœì¢… í•©ê²©ì¼']).replace(/\./g, '-'));
            if(!isNaN(s) && !isNaN(e)) lt.push({ title: d['ê³µê³ ëª…'], days: Math.round((e-s)/86400000) });
        });
        if(lt.length > 0) {
            lt.sort((a,b) => a.days - b.days);
            document.getElementById('avgLeadTime').innerText = Math.round(lt.reduce((a,b)=>a+b.days,0)/lt.length) + "ì¼";
            document.getElementById('minLeadTime').innerText = lt[0].days + "ì¼";
            document.getElementById('minLeadPos').innerText = lt[0].title;
            document.getElementById('maxLeadTime').innerText = lt[lt.length-1].days + "ì¼";
            document.getElementById('maxLeadPos').innerText = lt[lt.length-1].title;
        }

        // 5. ì±„ìš© ì‚¬ìœ ë³„ (ì‹ ê·œ/ëŒ€ì²´ë³„ ì˜¤í”ˆ vs ì™„ë£Œ)
        const rStats = { "ì‹ ê·œ": { active: 0, done: 0 }, "ëŒ€ì²´": { active: 0, done: 0 } };
        data.forEach(d => {
            const r = String(d['ì±„ìš©ì‚¬ìœ '] || "");
            const s = String(d['ìƒíƒœ']).trim();
            let key = r.includes("ì‹ ê·œ") ? "ì‹ ê·œ" : (r.includes("ëŒ€ì²´") ? "ëŒ€ì²´" : "");
            if(key) {
                if(s === "ì§„í–‰ì¤‘") rStats[key].active++;
                else if(s === "ì™„ë£Œ") rStats[key].done++;
            }
        });
        updateChart('reasonChart', 'bar', ["ì‹ ê·œì±„ìš©", "ëŒ€ì²´ì±„ìš©"], [
            { label: 'ì˜¤í”ˆ ê³µê³ ', data: [rStats["ì‹ ê·œ"].active, rStats["ëŒ€ì²´"].active], backgroundColor: '#E6221A' },
            { label: 'ì±„ìš© ì™„ë£Œ', data: [rStats["ì‹ ê·œ"].done, rStats["ëŒ€ì²´"].done], backgroundColor: '#53565A' }
        ], { scales: { x: { stacked: true }, y: { stacked: true, ...intAxis } } });

        // 6. ì§êµ° ë° ê³ ìš©í˜•íƒœ
        const cats = {}; done.forEach(d => { const g = String(d['ì§êµ°'] || "ë¯¸ë¶„ë¥˜").trim(); cats[g] = (cats[g] || 0) + 1; });
        updateChart('categoryChart', 'doughnut', Object.keys(cats), [{ data: Object.values(cats), backgroundColor: ['#E6221A', '#53565A', '#F37021'] }]);
        
        const types = ['ì •ê·œì§', 'ê³„ì•½ì§', 'íŒŒê²¬ì§'];
        updateChart('typeChart', 'bar', types, [
            { label: 'ì§„í–‰ì¤‘', data: types.map(t => active.filter(d => String(d['ê³ ìš©í˜•íƒœ']).includes(t)).length), backgroundColor: '#E6221A' },
            { label: 'ì™„ë£Œ', data: types.map(t => done.filter(d => String(d['ê³ ìš©í˜•íƒœ']).includes(t)).length), backgroundColor: '#53565A' }
        ], { scales: { x: { stacked: true }, y: { stacked: true, ...intAxis } } });
    }

    function processTO(data) {
        let total = 0, remLab = [], remVal = [], doneLab = [], doneVal = [];
        data.forEach(row => {
            const org = String(row[0]||"").trim(), cell = String(row[1]||"").trim();
            const dV = parseInt(row[3])||0, rV = parseInt(row[4])||0;
            if (org.includes("í•©ê³„")) total = rV;
            else if (org && org !== "ì¡°ì§") {
                if (org === cell) { remLab.push(org); remVal.push(rV); }
                else if (cell && cell !== "-") { doneLab.push(cell); doneVal.push(dV); }
            }
        });
        document.getElementById('totalTO').innerText = total + "ëª…";
        updateChart('toRemainChart', 'bar', remLab, [{ label: 'ì”ì—¬ T.O', data: remVal, backgroundColor: '#E6221A' }], { indexAxis: 'y', scales: { x: intAxis } });
        document.getElementById('doneContainer').style.height = Math.max(350, doneLab.length * 30) + "px";
        updateChart('toDoneChart', 'bar', doneLab, [{ label: 'ì±„ìš©ì™„ë£Œ', data: doneVal, backgroundColor: '#53565A' }], { indexAxis: 'y', scales: { x: intAxis } });
    }

    function updateChart(id, type, labels, datasets, extraOpts = {}) {
        if(charts[id]) charts[id].destroy();
        charts[id] = new Chart(document.getElementById(id), {
            type: type, data: { labels: labels, datasets: datasets },
            options: { maintainAspectRatio: false, responsive: true, ...extraOpts }
        });
    }
    init();
</script>
</body>
</html>
