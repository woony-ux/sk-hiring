<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKì¼ë ‰ë§í¬ ì±„ìš© ì „ëµ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --sk-red: #E6221A; --sk-orange: #F37021; --sk-gray: #53565A; --sk-light-gray: #f0f2f5; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--sk-light-gray); margin: 0; padding: 20px; }
        .header { background: linear-gradient(90deg, var(--sk-red), var(--sk-orange)); color: white; padding: 1rem; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .metric-card { background: white; padding: 15px; border-radius: 12px; text-align: center; border-bottom: 5px solid var(--sk-red); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .metric-value { font-size: 1.6rem; font-weight: bold; color: var(--sk-red); margin: 5px 0; }
        .metric-sub { font-size: 0.7rem; color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: block; }
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .full-width { grid-column: 1 / -1; }
        .chart-container { position: relative; min-height: 350px; width: 100%; }
        h2 { font-size: 1rem; margin-top: 0; color: #333; border-left: 4px solid var(--sk-red); padding-left: 10px; margin-bottom: 20px; }
        /* ìµœí•˜ë‹¨ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ (ë§í¬ í¬í•¨) */
        .pos-list-full { list-style: none; padding: 0; margin: 0; }
        .pos-item-full { background: #fff; padding: 12px 20px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 8px; display: flex; align-items: center; font-size: 0.95rem; }
        .pos-item-full a { text-decoration: none; color: #333; font-weight: 500; transition: color 0.2s; }
        .pos-item-full a:hover { color: var(--sk-red); text-decoration: underline; }
        .pos-item-full::before { content: 'ğŸš€'; margin-right: 12px; }
    </style>
</head>
<body>

<div class="header"><h1>SK electlink Recruitment Dashboard</h1></div>

<div class="metric-grid">
    <div class="metric-card"><h3>ì§„í–‰ì¤‘ ê³µê³ </h3><div id="openCount" class="metric-value">-</div></div>
    <div class="metric-card">
        <h3>ì „ëµì±„ìš©</h3>
        <div id="strategyCount" class="metric-value">-</div>
        <div class="metric-sub">(CEO ì§ì ‘ ì˜ì…)</div>
    </div>
    <div class="metric-card"><h3>í‰ê·  ë¦¬ë“œíƒ€ì„</h3><div id="avgLeadTime" class="metric-value">-</div></div>
    <div class="metric-card"><h3>ìµœë‹¨ ë¦¬ë“œíƒ€ì„</h3><div id="minLeadTime" class="metric-value">-</div><div id="minLeadPos" class="metric-sub">-</div></div>
    <div class="metric-card"><h3>ìµœì¥ ë¦¬ë“œíƒ€ì„</h3><div id="maxLeadTime" class="metric-value">-</div><div id="maxLeadPos" class="metric-sub">-</div></div>
    <div class="metric-card"><h3>2026 ì”ì—¬ T.O</h3><div id="totalTO" class="metric-value">-</div></div>
</div>

<div class="chart-grid">
    <div class="card full-width"><h2>ì›”ë³„ ì±„ìš© ì™„ë£Œ ì¶”ì´</h2><div class="chart-container"><canvas id="monthlyChart"></canvas></div></div>
    <div class="card full-width"><h2>ì¡°ì§ ë° íŒ€ë³„ ì”ì—¬ T.O í˜„í™©</h2><div class="chart-container"><canvas id="toRemainChart"></canvas></div></div>
    <div class="card full-width"><h2>ì…€ë³„ ì±„ìš© ì™„ë£Œ í˜„í™©</h2><div id="doneContainer" class="chart-container"><canvas id="toDoneChart"></canvas></div></div>
    <div class="card"><h2>ì±„ìš© ì™„ë£Œ ì§êµ° êµ¬ì„±</h2><div class="chart-container"><canvas id="categoryChart"></canvas></div></div>
    <div class="card"><h2>ê³ ìš© í˜•íƒœë³„</h2><div class="chart-container"><canvas id="typeChart"></canvas></div></div>
    <div class="card full-width"><h2>ì±„ìš© ì‚¬ìœ ë³„</h2><div class="chart-container"><canvas id="reasonChart"></canvas></div></div>
</div>

<div class="card full-width">
    <h2>í˜„ì¬ ì§„í–‰ ì¤‘ì¸ í¬ì§€ì…˜ ëª…ë‹¨</h2>
    <div id="positionListFull" class="pos-list-full">ë°ì´í„° ë¡œë”© ì¤‘...</div>
</div>

<script>
    const posUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS4NyWr_pNBx82IrYqAeZV60ST3D14ZzH2F1uYsHrpGWQ9PQ8KP8MLR98Ao_yppXjwqoHwqR-AvLRyR/pub?gid=867729802&single=true&output=csv";
    const toUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS4NyWr_pNBx82IrYqAeZV60ST3D14ZzH2F1uYsHrpGWQ9PQ8KP8MLR98Ao_yppXjwqoHwqR-AvLRyR/pub?gid=770067438&single=true&output=csv";

    let charts = {};
    const intAxis = { ticks: { stepSize: 1, precision: 0 }, beginAtZero: true };

    function init() {
        Papa.parse(posUrl, { download: true, header: false, skipEmptyLines: true, complete: res => processPos(res.data) });
        Papa.parse(toUrl, { download: true, header: false, skipEmptyLines: true, complete: res => processTO(res.data) });
    }

    function processPos(data) {
        const rows = data.slice(1);
        
        // --- 1. ì „ëµì±„ìš©(CEO ì˜ì…) ì¹´ìš´íŠ¸ ë¡œì§ ê°•í™” ---
        let strategyRowsCount = 0;
        let isStrategySection = false;
        
        data.forEach(row => {
            const firstCol = String(row[0] || "").trim();
            if (firstCol.includes("ì „ëµì±„ìš©") || firstCol.includes("CEO")) {
                isStrategySection = true;
                return;
            }
            if (isStrategySection && firstCol && !firstCol.includes("í•©ê³„") && !firstCol.includes("ê³µê³ ëª…")) {
                strategyRowsCount++;
            }
        });
        document.getElementById('strategyCount').innerText = strategyRowsCount + "ê±´";

        // --- 2. ì§„í–‰ì¤‘ í¬ì§€ì…˜ í•˜ì´í¼ë§í¬ ì—°ê²° ---
        // ì‹œíŠ¸ì˜ ë§í¬ ë°ì´í„°ëŠ” ì¼ë°˜ì ìœ¼ë¡œ CSV ì¶”ì¶œ ì‹œ URL í…ìŠ¤íŠ¸ê°€ í¬í•¨ë˜ê±°ë‚˜ íŠ¹ì • ì—´ì— ìœ„ì¹˜í•¨
        // ì—¬ê¸°ì„œëŠ” ë°ì´í„°ì˜ ì²« ë²ˆì§¸ ì—´(ê³µê³ ëª…)ì— ë§í¬ê°€ ìˆë‹¤ê³  ê°€ì •í•˜ê³  ì²˜ë¦¬í•˜ê±°ë‚˜, 
        // ì‹œíŠ¸ì—ì„œ ì¶”ì¶œëœ ë°ì´í„° ì¤‘ URL í˜•ì‹ì„ ì°¾ì•„ ì—°ê²°í•¨
        const active = rows.filter(r => String(r[4]).trim() === 'ì§„í–‰ì¤‘');
        const done = rows.filter(r => String(r[4]).trim() === 'ì™„ë£Œ');

        document.getElementById('openCount').innerText = active.length + "ê±´";
        
        document.getElementById('positionListFull').innerHTML = active.map(r => {
            // ì‹œíŠ¸ì—ì„œ 'ê³µê³ ëª…' ì•ˆì— ë§í¬ê°€ í¬í•¨ë˜ì–´ ì¶”ì¶œë˜ëŠ” ê²½ìš°ê°€ ë§ìœ¼ë¯€ë¡œ ì´ë¥¼ í™œìš©
            // ë§Œì•½ ì‹œíŠ¸ì— ë³„ë„ì˜ ë§í¬ ì—´ì´ ìˆë‹¤ë©´ r[ë²ˆí˜¸]ë¥¼ ìˆ˜ì •í•´ì•¼ í•¨
            const title = r[0];
            const link = r[13] || "#"; // 14ë²ˆì§¸ ì—´(Nì—´) ë“±ì— ë§í¬ê°€ ìˆë‹¤ê³  ê°€ì • (í•„ìš” ì‹œ ìˆ˜ì •)
            return `<div class="pos-item-full"><a href="${link}" target="_blank">${title}</a></div>`;
        }).join('');

        // 3. ì°¨íŠ¸ ë°ì´í„° ì²˜ë¦¬ (ê¸°ì¡´ ìœ ì§€)
        const months = { "2025-12": 0, "2026-01": 0, "2026-02": 0 };
        done.forEach(r => {
            const m = String(r[6]).match(/(\d{4})[\.\s-]+(\d{1,2})/);
            if(m) {
                const key = `${m[1]}-${m[2].padStart(2, '0')}`;
                if(months.hasOwnProperty(key)) months[key]++;
            }
        });
        updateChart('monthlyChart', 'bar', ["25ë…„ 12ì›”", "26ë…„ 1ì›”", "26ë…„ 2ì›”"], [{ label: 'ì¸ì›', data: Object.values(months), backgroundColor: '#E6221A' }], { scales: { y: intAxis } });

        let lt = [];
        done.forEach(r => {
            const s = new Date(String(r[5]).replace(/\./g, '-')), e = new Date(String(r[6]).replace(/\./g, '-'));
            if(!isNaN(s) && !isNaN(e)) lt.push({ title: r[0], days: Math.round((e-s)/86400000) });
        });
        if(lt.length > 0) {
            lt.sort((a,b) => a.days - b.days);
            document.getElementById('avgLeadTime').innerText = Math.round(lt.reduce((a,b)=>a+b.days,0)/lt.length) + "ì¼";
            document.getElementById('minLeadTime').innerText = lt[0].days + "ì¼";
            document.getElementById('minLeadPos').innerText = lt[0].title;
            document.getElementById('maxLeadTime').innerText = lt[lt.length-1].days + "ì¼";
            document.getElementById('maxLeadPos').innerText = lt[lt.length-1].title;
        }

        const rStats = { "ì‹ ê·œ": { active: 0, done: 0 }, "ëŒ€ì²´": { active: 0, done: 0 } };
        rows.forEach(r => {
            const reason = String(r[8] || ""), status = String(r[4]).trim();
            let key = reason.includes("ì‹ ê·œ") ? "ì‹ ê·œ" : (reason.includes("ëŒ€ì²´") ? "ëŒ€ì²´" : "");
            if(key) {
                if(status === "ì§„í–‰ì¤‘") rStats[key].active++;
                else if(status === "ì™„ë£Œ") rStats[key].done++;
            }
        });
        updateChart('reasonChart', 'bar', ["ì‹ ê·œì±„ìš©", "ëŒ€ì²´ì±„ìš©"], [
            { label: 'ì˜¤í”ˆ ê³µê³ ', data: [rStats["ì‹ ê·œ"].active, rStats["ëŒ€ì²´"].active], backgroundColor: '#E6221A' },
            { label: 'ì±„ìš© ì™„ë£Œ', data: [rStats["ì‹ ê·œ"].done, rStats["ëŒ€ì²´"].done], backgroundColor: '#53565A' }
        ], { scales: { x: { stacked: true }, y: { stacked: true, ...intAxis } } });

        const cats = {}; done.forEach(r => { const g = String(r[11] || "ë¯¸ë¶„ë¥˜").trim(); cats[g] = (cats[g] || 0) + 1; });
        updateChart('categoryChart', 'doughnut', Object.keys(cats), [{ data: Object.values(cats), backgroundColor: ['#E6221A', '#53565A', '#F37021'] }]);
        
        const types = ['ì •ê·œì§', 'ê³„ì•½ì§', 'íŒŒê²¬ì§'];
        updateChart('typeChart', 'bar', types, [
            { label: 'ì§„í–‰ì¤‘', data: types.map(t => active.filter(r => String(r[7]).includes(t)).length), backgroundColor: '#E6221A' },
            { label: 'ì™„ë£Œ', data: types.map(t => done.filter(r => String(r[7]).includes(t)).length), backgroundColor: '#53565A' }
        ], { scales: { x: { stacked: true }, y: { stacked: true, ...intAxis } } });
    }

    function processTO(data) {
        let total = 0, remLab = [], remVal = [], doneLab = [], doneVal = [];
        data.forEach(row => {
            const org = String(row[0]||"").trim(), cell = String(row[1]||"").trim();
            const dV = parseInt(row[3])||0, rV = parseInt(row[4])||0;
            if (org.includes("í•©ê³„")) total = rV;
            else if (org && org !== "ì¡°ì§") {
                if (org === cell) { remLab.push(org); remVal.push(rV); }
                else if (cell && cell !== "-") { doneLab.push(cell); doneVal.push(dV); }
            }
        });
        document.getElementById('totalTO').innerText = total + "ëª…";
        updateChart('toRemainChart', 'bar', remLab, [{ label: 'ì”ì—¬ T.O', data: remVal, backgroundColor: '#E6221A' }], { indexAxis: 'y', scales: { x: intAxis } });
        document.getElementById('doneContainer').style.height = Math.max(350, doneLab.length * 30) + "px";
        updateChart('toDoneChart', 'bar', doneLab, [{ label: 'ì±„ìš©ì™„ë£Œ', data: doneVal, backgroundColor: '#53565A' }], { indexAxis: 'y', scales: { x: intAxis } });
    }

    function updateChart(id, type, labels, datasets, extraOpts = {}) {
        if(charts[id]) charts[id].destroy();
        charts[id] = new Chart(document.getElementById(id), {
            type: type, data: { labels: labels, datasets: datasets },
            options: { maintainAspectRatio: false, responsive: true, ...extraOpts }
        });
    }
    init();
</script>
</body>
</html>
